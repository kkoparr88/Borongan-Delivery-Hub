<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Borongan Delivery Hub | Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

/* --- MAIN THEME --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { background: linear-gradient(135deg, #0d2a3a, #1b4f72); color: #eee; min-height: 100vh; overflow-x: hidden; }

.app { display: flex; min-height: 100vh; }

/* --- SIDEBAR --- */
.sidebar { 
  background-color: #0a1f2e; 
  width: 320px; 
  min-width: 320px; 
  padding: 25px; 
  border-right: 2px solid #00aaff; 
  box-shadow: 5px 0 15px rgba(0,0,0,0.3); 
}

.sidebar h2 { 
  font-size: 20px; 
  margin-bottom: 15px; 
  color: #00aaff; 
  border-bottom: 2px solid #00aaff; 
  padding-bottom: 5px; 
}

.sidebar label { font-size: 13px; margin-top: 12px; display: block; color: #88ccee; }

/* SHARED STYLE FOR ALL INPUTS */
.sidebar input, .sidebar textarea, .sidebar select, .address-card select { 
  width: 100%; 
  padding: 12px; 
  margin-top: 8px; 
  margin-bottom: 5px;
  border-radius: 10px; 
  border: 1px solid #1b4f72; 
  background: #163545; 
  color: #fff; 
  outline: none; 
  font-size: 14px;
  transition: all 0.3s ease;
}

/* SPECIFIC STYLE FOR DROPDOWNS ONLY */
.sidebar select, .address-card select {
  appearance: none; 
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2300aaff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: calc(100% - 15px) center;
  cursor: pointer;
  padding-right: 35px;
}

.sidebar input:focus, .sidebar textarea:focus, .sidebar select:focus {
  border-color: #00aaff;
  background-color: #1c445a;
}

#item { resize: vertical; min-height: 80px; }

.qty-row { display: flex; gap: 10px; }
.qty-row input { width: 80px; text-align: center; }

.sidebar button { 
  margin-top: 20px; 
  background: linear-gradient(90deg, #00aaff, #0077cc); 
  border: none; 
  color: white; 
  padding: 12px; 
  width: 100%; 
  border-radius: 8px; 
  font-weight: 600; 
  cursor: pointer; 
  transition: 0.3s; 
}

.sidebar button:hover { opacity: 0.9; transform: translateY(-2px); }

.main { flex: 1; padding: 40px; }

.hero { 
  background: rgba(255,255,255,0.05); 
  padding: 30px; 
  border-radius: 15px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  border-left: 5px solid #00aaff; 
  margin-bottom: 30px; 
}

table { width: 100%; border-collapse: collapse; background: #0a1f2e; border-radius: 10px; overflow: hidden; margin-bottom: 30px; }
th { background: #163545; padding: 15px; color: #00aaff; text-align: left; }
td { padding: 15px; border-bottom: 1px solid #1b4f72; }
.del-btn { color: #ff4d4d; background: none; border: none; cursor: pointer; font-size: 18px; }

.info-frame { 
  background: rgba(0, 170, 255, 0.05); 
  padding: 25px; 
  border-radius: 12px; 
  border: 1px solid #00aaff; 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 15px; 
  margin-bottom: 20px; 
}
.total-row { grid-column: span 2; border-top: 1px solid #00aaff; padding-top: 10px; font-size: 20px; font-weight: bold; color: #00aaff; }

.drawer { position: fixed; right: -450px; top: 0; width: 400px; height: 100%; background: #0a1f2e; transition: 0.5s; z-index: 3000; padding: 30px; border-left: 3px solid #00aaff; }
.drawer.active { right: 0; }
.notif-btn { cursor: pointer; font-size: 24px; border: 2px solid #00aaff; padding: 10px; border-radius: 50%; color: #00aaff; }

#addressOverlay { 
  display: none; 
  position: fixed; 
  top: 0; left: 0; 
  width: 100%; height: 100%; 
  background: rgba(0,0,0,0.8); 
  z-index: 9999; 
  justify-content: center; 
  align-items: center; 
  backdrop-filter: blur(5px); 
}
.address-card { 
  background: #0d2a3a; 
  padding: 35px; 
  border-radius: 20px; 
  border: 2px solid #00aaff; 
  width: 400px; 
  box-shadow: 0 0 30px rgba(0,170,255,0.3); 
}
.action-buttons { display: flex; gap: 20px; }

select option {
  background: #0a1f2e;
  color: #fff;
}
</style>
</head>

  <body>

<div id="addressOverlay">
    <div class="address-card animate__animated animate__fadeInDown">
        <h3 style="text-align:center; color:#fff; margin-bottom:20px;">üöö Delivery Destination</h3>
        <label style="color:#00aaff; font-size:12px;">City / Municipality</label>
        <select id="citySelect" onchange="filterBarangays()">
            <option value="" disabled selected>Select City</option>
        </select>
        <label style="color:#00aaff; font-size:12px;">Select Barangay</label>
        <select id="brgySelect">
            <option value="" disabled selected>Select City First</option>
        </select>
        <button onclick="saveLocation()" style="width:100%; padding:15px; background:#00aaff; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; margin-top:20px;">Confirm Location</button>
    </div>
</div>

<div id="sideDrawer" class="drawer">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="color:#00aaff;">Notifications</h3>
        <button onclick="toggleDrawer()" style="background:none; border:none; color:white; font-size:30px; cursor:pointer;">&times;</button>
    </div>
    <div id="drawerContent" style="margin-top:20px; color:#ccc;">No new messages.</div>
</div>

<div class="app">
    <div class="sidebar">
        <h2>Customer</h2>
        <label>Full Name</label><input id="custName" disabled>
        <label>Email</label><input id="custEmail" disabled>
        <label>Home Address</label><textarea id="custAddress" disabled rows="2" style="resize:none;"></textarea>
        
        <h2 style="margin-top:30px;">New Order</h2>
        <label>Item Name (Resizable)</label>
        <textarea id="item" placeholder="What are we buying today?"></textarea>
        
        <label>Quantity & Unit</label>
        <div class="qty-row">
            <input type="number" id="qty" value="1">
            <select id="uom" onchange="handleUomChange()">
                <option value="pcs">pcs</option>
                <option value="kg">kg</option>
                <option value="order">order</option>
                <option value="others">others</option>
            </select>
        </div>
        <input id="uomOther" type="text" placeholder="Specify unit..." style="display:none; margin-top:8px;">
        
        <label>Source Store</label><input id="source" placeholder="Store name...">

        <label>Additional Fee (‚Ç±)</label>
        <input type="number" id="extraFeeInput" value="0" oninput="calculateFees()" placeholder="0">

        <button onclick="addOrder()">Add to List</button>
        <button onclick="logout()" style="background:#441111; margin-top:10px;">Logout</button>
    </div>

    <div class="main">
        <div class="hero">
            <div>
                <h1>Borongan Hub üöö</h1>
                <p>Welcome, <span id="welcomeName" style="color:#00aaff;">Guest</span></p>
            </div>
            <div class="notif-btn" onclick="toggleDrawer()">üîî</div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Item Description</th>
                    <th style="width:80px;">Qty</th>
                    <th style="width:100px;">Unit</th>
                    <th>Source</th>
                    <th style="width:50px;"></th>
                </tr>
            </thead>
            <tbody id="orderTable"></tbody>
        </table>

        <div class="info-frame">
            <div>Customer: <strong id="summName">--</strong></div>
            <div>Deliver To: <strong id="dispLoc" style="color:#00aaff;">NOT SET</strong></div>
            <div>Location Fee: ‚Ç±<span id="locCost">0</span></div>
            <div>Handling Fee: ‚Ç±<span id="srcCost">0</span></div>
            <div>Additional Fee: ‚Ç±<span id="extraCostDisp">0</span></div>
            <div class="total-row">Estimated Total: ‚Ç±<span id="totalCost">0</span></div>
        </div>

        <div class="action-buttons">
            <button onclick="openLocationModal()" style="background:#163545; color:white; padding:15px; border-radius:8px; flex:1; cursor:pointer; border: 1px solid #00aaff;">üìç Set Destination</button>
            <button id="sendBtn" onclick="sendOrder()" style="background:#00aaff; color:white; padding:15px; border-radius:8px; flex:1; border:none; font-weight:bold; cursor:pointer;">üöÄ Send to Rider</button>
        </div>
    </div>
</div>

    <script>
// ---------- MASTER CONFIGURATION ----------
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyru01ycKnnMpS41lmrvz6v-s_VgJo6MxM93BznvlwqKCDFaVopyzPIp0ysNbzLprOe/exec"; 
// ADD YOUR RIDERS DB SCRIPT URL HERE
const RIDER_DB_URL = "https://script.google.com/macros/s/AKfycbzHvgmLAioBVD5kTTBUt-JI2t097rmU_rx4LngDuedKspuuftz88c7EsqndSFAW6jFX/exec";

let orders = [], fullData = { brgy: [], cities: [] };

function setupLocations(res) {
    if (res.success) {
        fullData = res;
        const citySelect = document.getElementById("citySelect");
        citySelect.innerHTML = '<option value="" disabled selected>Choose City</option>';
        res.cities.forEach(c => {
            let opt = document.createElement("option"); 
            opt.value = c; opt.innerText = c;
            citySelect.appendChild(opt);
        });
    }
}

function openLocationModal() {
    document.getElementById("addressOverlay").style.display = "flex";
    if (fullData.cities.length === 0) {
        const script = document.createElement('script');
        script.src = `${WEB_APP_URL}?action=getBarangayData&callback=setupLocations`;
        document.body.appendChild(script);
    }
}

window.onload = function() {
    const customer = JSON.parse(localStorage.getItem('customer'));
    if (customer) {
        document.getElementById('custName').value = customer.name;
        document.getElementById('custEmail').value = customer.email;
        document.getElementById('custAddress').value = customer.address;
        document.getElementById('summName').innerText = customer.name;
        document.getElementById('welcomeName').innerText = customer.name;
    }
};

function filterBarangays() {
    const selectedCity = document.getElementById("citySelect").value;
    const brgySelect = document.getElementById("brgySelect");
    brgySelect.innerHTML = '<option value="" disabled selected>Choose Barangay</option>';
    fullData.brgy.filter(b => b.city === selectedCity).forEach(b => {
        let opt = document.createElement("option"); 
        opt.value = b.name; opt.innerText = b.name;
        brgySelect.appendChild(opt);
    });
}

function saveLocation() {
    const brgy = document.getElementById("brgySelect").value;
    const city = document.getElementById("citySelect").value;
    const brgyObj = fullData.brgy.find(b => b.name === brgy && b.city === city);
    document.getElementById("dispLoc").innerText = brgy + ", " + city;
    document.getElementById("locCost").innerText = brgyObj ? brgyObj.cost : 0;
    calculateFees();
    document.getElementById("addressOverlay").style.display = "none";
}

function addOrder() {
    const itemVal = document.getElementById("item").value;
    const srcVal = document.getElementById("source").value;
    if(!itemVal || !srcVal) return alert("Fill in Item and Source!");
    let uom = document.getElementById("uom").value;
    if(uom === "others") uom = document.getElementById("uomOther").value;
    orders.push({ item: itemVal, qty: document.getElementById("qty").value, uom: uom, src: srcVal.toUpperCase() });
    renderOrders(); 
    calculateFees();
    document.getElementById("item").value = ""; 
    document.getElementById("source").value = "";
}

function renderOrders() {
    const tbody = document.getElementById("orderTable");
    tbody.innerHTML = "";
    orders.forEach((o, i) => {
        tbody.innerHTML += `<tr><td>${o.item}</td><td>${o.qty}</td><td>${o.uom}</td><td>${o.src}</td><td><button class="del-btn" onclick="removeOrder(${i})">‚úñ</button></td></tr>`;
    });
}

// UPDATED CALCULATE FEES (Including Plugin 1)
function calculateFees() {
    const uniqueSources = [...new Set(orders.map(o => o.src))].length;
    const srcFee = uniqueSources * 50;
    const locFee = parseInt(document.getElementById("locCost").innerText) || 0;
    const extraFee = parseInt(document.getElementById("extraFeeInput").value) || 0;
    
    document.getElementById("srcCost").innerText = srcFee;
    document.getElementById("extraCostDisp").innerText = extraFee;
    document.getElementById("totalCost").innerText = srcFee + locFee + extraFee;
}

// PLUGIN 2: FAIR-LOAD BALANCING SEND ORDER
function sendOrder() {
    if(orders.length === 0) return alert("Add items first!");
    if(document.getElementById("dispLoc").innerText === "NOT SET") return alert("Set destination first!");

    document.getElementById("sendBtn").innerText = "Finding Best Rider...";
    document.getElementById("sendBtn").disabled = true;

    // Call the Rider Selection Script
    const script = document.createElement('script');
    script.src = `${RIDER_DB_URL}?action=findBestRider&callback=handleRiderResponse`;
    document.body.appendChild(script);
}

function handleRiderResponse(res) {
    if(res.success) {
        alert("Success! Order sent to Rider: " + res.riderID);
        // Reset App after success
        orders = [];
        renderOrders();
        document.getElementById("sendBtn").innerText = "üöÄ Send to Rider";
        document.getElementById("sendBtn").disabled = false;
    } else {
        alert("Error: " + res.message);
        document.getElementById("sendBtn").innerText = "üöÄ Send to Rider";
        document.getElementById("sendBtn").disabled = false;
    }
}

function handleUomChange() {
    const uom = document.getElementById("uom").value;
    document.getElementById("uomOther").style.display = (uom === "others") ? "block" : "none";
}

function removeOrder(i) { orders.splice(i, 1); renderOrders(); calculateFees(); }
function toggleDrawer() { document.getElementById("sideDrawer").classList.toggle("active"); }
function logout() { localStorage.clear(); window.location.replace('login.html'); }
</script>
</body>
</html>

    

